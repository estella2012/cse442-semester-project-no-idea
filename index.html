<!DOCTYPE html>
<html>
<head>
    <script src="./phaser.min.js"></script>
    <script src="./phaser-arcade-physics.min.js"></script>
</head>
<body style="padding: 0; margin: 0; background-color: #000000;">
    <script type="module">
    import { SmInventoryContainer, MdInventoryContainer, LgInventoryContainer } from "./inventory_container.js";
    import { Inventory } from "./inventory_screen.js";
    import { Player } from "./player.js";
    import { GoldKey, SilverKey, SilverDoor } from "./item.js";
    import { Door } from "./door.js";

    var config = {
        type: Phaser.AUTO,
        backgroundColor: '#000000',
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 800,
            height: 600
        },
        physics: {
            default: 'arcade',
            arcade: {
                debug: false
            }
        },
        scene: {
            init: init,
            preload: preload,
            create: create,
            update: update
        }
    };

    var cursors;
    var playerObj = new Player();
    var game = new Phaser.Game(config);

    var canCheckInventory = true;
    var inventory = undefined;
    var keyboardKeyI = undefined;

    function init() {
        this.inventory = undefined;

        Phaser.GameObjects.GameObjectFactory.register('inventoryScreen', function(x, y) {
            var sprite = new Inventory(this.scene);
            this.displayList.add(sprite);
            return sprite;
        });
        Phaser.GameObjects.GameObjectFactory.register('smInventoryCont', function(x, y) {
            var sprite = new SmInventoryContainer(x, y, this.scene);
            this.displayList.add(sprite);
            return sprite;
        });
        Phaser.GameObjects.GameObjectFactory.register('mdInventoryCont', function(x, y) {
            var sprite = new MdInventoryContainer(x, y, this.scene);
            this.displayList.add(sprite);
            return sprite;
        });
        Phaser.GameObjects.GameObjectFactory.register('lgInventoryCont', function(x, y) {
            var sprite = new LgInventoryContainer(x, y, this.scene);
            this.displayList.add(sprite);
            return sprite;
        });
        Phaser.GameObjects.GameObjectFactory.register('silverKey', function(x, y) {
            var sprite = new SilverKey(x, y, this.scene);
            this.displayList.add(sprite);
            return sprite;
        });
        Phaser.GameObjects.GameObjectFactory.register('goldKey', function(x, y) {
            var sprite = new GoldKey(x, y, this.scene);
            this.displayList.add(sprite);
            return sprite;
        });
        Phaser.GameObjects.GameObjectFactory.register('silverDoor', function(x, y) {
            var sprite = new SilverDoor(x, y, this.scene);
            this.displayList.add(sprite);
            return sprite;
        });
    }

    function preload()
    {
        this.load.image('inventory_bg', 'assets/inventory_bg.png');
        this.load.image('inv_sm_slot', 'assets/inventory_slot_sm.png');
        this.load.image('inv_md_slot', 'assets/inventory_slot_md.png');
        this.load.image('inv_lg_slot', 'assets/inventory_slot_lg.png');

        this.load.image('sky', 'assets/sky.png');
        this.load.spritesheet('door', 'assets/door.png', { frameWidth: 32, frameHeight: 48 });

        this.load.image('key_silver', 'assets/key_silver.png');
        this.load.image('key_gold', 'assets/key_gold.png');

        playerObj.preload(this);
    }

    function create()
    {
        createAnims();

        this.add.image(400, 300, 'sky');

        cursors = this.input.keyboard.createCursorKeys();
        playerObj.create(100, 450, this);

        var sk = this.physics.add.existing(this.add.silverKey(150, 500), 1);
        var gk = this.physics.add.existing(this.add.goldKey(200, 500), 1);
        var sDoor = this.physics.add.existing(this.add.silverDoor(400, 500), 1);

        this.physics.add.collider(playerObj.self, sk, collect);
        this.physics.add.collider(playerObj.self, gk, collect);
        this.physics.add.collider(playerObj.self, sDoor, tryOpen);

        keyboardKeyI = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.I);
        inventory = this.add.inventoryScreen();
        inventory.buildInvContainers();
    }

    function update()
    {
        playerObj.update(cursors);

        if (canCheckInventory && keyboardKeyI.isDown) {
            if (inventory.active) {
                inventory.destroyContainers();
            } else {
                inventory.showContainers();
            }
            canCheckInventory = false;
            this.time.addEvent({ delay: 200, callback: function() { canCheckInventory = true; }, callbackScope: this});
        }
    }

    function collect(player, item) {
        inventory.addItem(item);
    }

    function tryOpen(player, door) {
        if (door.closed && inventory.deleteItem(door.requiredItem)) {
            door.open();
        }
    }

    function createAnims() {
        game.anims.create({
            key: 'door_closed',
            frames: [ { key: 'door', frame: 0 } ],
            frameRate: 10
        });

        game.anims.create({
            key: 'door_open',
            frames: [ { key: 'door', frame: 1 } ],
            frameRate: 20
        });
    }
    </script>
</body>
</html>